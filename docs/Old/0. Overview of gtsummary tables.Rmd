---
title: "Overview of gtsummary tables"
output: html_document
date: "2025-05-16"
---

<br> 

```{r packages, collapse=TRUE, include=FALSE}
library(tidyverse)
library(flextable)
library(officer)
```

# Overview

These `gtsummary` functions are 'ok' but not great. However, given that `gtsummary` itself does not seem the perfect medium to work in - don't try to perfect them. Learn from this experience and apply a-fresh elsewhere. 

Functions are stored at this file path: /Users/joecrowley/R/Tables/gtsummary

Note, when I transferred to Mac files starting with '.' became hidden. They are still there, 'shift + cmd + .' will reveal them.

```{r function locations}

# Review available functions
ddir <- "/Users/joecrowley/R/Tables/gtsummary/"

# Available files
# List all .R files in ddir 
file_paths <- list.files(path = ddir, pattern = "\\.R$", full.names = TRUE, all.files = T) %>% 
  map_chr(., ~str_remove(.x, ddir))

# Set of functions to be loaded. 
file_paths

```

```{r results='hide'}

# Load all functions (make sure no other .R files in this location)
map(file_paths, ~source(paste0(ddir,.x)))

```

```{r}

# Functions can now be called
.nums

```

<br> 

**Thoughts**

Creating lots of separate functions was good in that they are small and digestible - but bad in that they are not really that flexible. Rather, build single more multi-purpose functions, composed of several independently function components that can be tested and understood outside of that wider system. Might be better. It would almost certainly be simpler to use. An early example of this are the secondary multicode functions, which are more like a swiss-army knife. One function that has multiple applications. 

<br> 

**Overview**

* All weighted tables are fed a survey-design object. You do not set the weights as part of the function.  

* All categorical functions expect factors, numeric ones numeric variables. Binary data should be either yes / no, 0 / 1 or TRUE / FALSE. Yes / no should be a factor. Drop unused levels unless you want them to display. 

* Variable should have labels.   

<br> 

**Specific functions:**  

*Totals*

* For categorical data, allowing multiple variables stacked on top of each other, see Function 1 `.freq` and 2 `.svy_freq`.   
* For numeric data, use function 11 `.nums` (statistics on one 1 line), and 12 `.nums2` (statistics on multiple lines).   
  * For weights - see functions 14 `.svy_nums` and 15 `.svy_nums2`.   
* For multiple categorical variables with the same levels, use `.mfreq`.

*Categorical crossbreaks*   

* Functions 6 `.cbreak` and 9 `.svy_cbreak` create a crossbreak table allowing *multiple outcomes* but only *one predictor*. Results are presented in a single table. 
* Functions 7 `.cbreaks` and 10 `.svy_cbreaks` present the same crossbreaks, but with results split into separate tables (provided in a list).  
* Nested crossbreaks are functions 20 `.ncbreak` and 21 `.svy_ncbreak`.  
  * Generally I don't think the `gtsummary` style outputs are better so don't describe them, but here they arguably are, so for a stacked `gtsummmary` style output see function 23 `.gt_ncbreak`. 

*Numeric crossbreaks*

* Functions 13 `.nums2_cbreak` and 16 `.svy_nums2_cbreak` - these provide multiple statistics per numeric outcome spread over several lines, crosstabulated by *one variable*, however, *multiple outcomes* are allowed.  
* Functions 22 `.nums2_ncbreak` and 23 `.svy_nums2_ncbreak` are the nested versions.

*Multicodes* 

* Functions 17 `.multi` and 18 `.multi_cbreak` provide a multicode function and multicode function with crossbreaks. Both are unweighted.   

These were too complicated so were replaced with function 26 `.mprop`, which is a bit more flexible, containing both frequencies and crossbreaks. Unlike most of these functions, this one allows multiple crossbreaks, which are then merged into a single wide table. No weighted or nested versions of this exist. 

<br> 

## Summary of functions

```{r functions overview, echo=FALSE, out.width="100%"}

std_border <- fp_border(color = "grey")

data.frame(
  `1` = c("Frequencies - unweighted", "done", "-", "done", ".freq"), 
  `2` = c("Frequencies - weighted", "done", "-", "done", ".svy_freq"), 
  `3` = c("Proportion - unweighted (da)", "-", "-", "-", "in .freq"), 
  `4` = c("Proportion - weighted (da)", "-", "-", "-", "in .svy_freq"), 
  `5` = c("Crossbreaks (stacked) - unweighted - gtsummary style", "done", "done", "done", ".gt_cbreak"),
  `6` = c("Crossbreaks (stacked) - unweighted - NatCen style", "done", "done", "done", ".cbreak"),
  `7` = c("Crossbreaks (separate) - unweighted - NatCen style", "done", "done", "done", ".cbreaks"),
  `8` = c("Crossbreaks (stacked) - weighted - gtsummary style", "done", "done", "done", ".svy_gt_cbreak"),
  `9` = c("Crossbreaks (stacked) - weighted - NatCen style", "done", "done", "done", ".svy_cbreak"),
  `10` = c("Crossbreaks (separate) - weighted - NatCen style", "done", "done", "done", ".svy_cbreaks"),
  `11` = c("Numerics - one line - unweighted", "done", "-", "done", ".nums"), 
  `12` = c("Numerics - multi-line - unweighted", "done", "-", "-", ".nums2"), 
  `13` = c("Numeric crossbreaks - multi-line - unweighted", "done", "done", "-", ".nums2_cbreak"), 
  `14` = c("Numerics - one line - weighted", "done", "-", "done", ".svy_nums"), 
  `15` = c("Numerics - multi-line - weighted", "done", "-", "-", ".svy_nums2"), 
  `16` = c("Numeric crossbreaks - multi-line - weighted", "done", "done", "-", ".svy_nums2_cbreak"), 
  `17` = c("Binaries unweighted", "done", "-", "tbc", ".multi"),
  `18` = c("Binaries unweighted - crossbreak", "done", "tbc", "tbc", ".multi_cbreak"),
  `19` = c("Nested - crossbreaks (stacked) - unweighted - gtsummary style", "tbc", "tbc", "tbc", ".gt_ncbreak"),
  `20` = c("Nested - crossbreak (one at a time) - NatCen style", "done", "done", "tbc", ".ncbreak"),
  `21` = c("Nested - crossbreak (one at a time) - weighted - NatCen style", "done", "done", "tbc", ".svy_ncbreak"), 
  `22` = c("Nested -Numeric crossbreaks - multi-line - unweighted", "done", "done", "-", ".nums2_ncbreak"), 
  `23` = c("Nested - Numeric crossbreaks - multi-line - weighted", "done", "done", "-", ".svy_nums2_ncbreak"), 
  `24` = c("Merged frequencies- unweighted", "-", "-", "-", ".mfreq"), 
  `25` = c("Merged frequencies- weighted", "-", "-", "-", "tbc - .svy_mfreq"), 
  `26` = c("Multicodes - unweighted - flexbile", "done", "done", "done", ".mprop")
    ) %>% 
  t() %>% as.data.frame %>% 
  mutate(N = row_number()) %>% 
  relocate(N) %>%
  flextable() %>% autofit() %>% 
  set_header_labels(V1 = "Table", 
                    V2 = "Complete", 
                    V3 = "p-value", 
                    V4 = "CI", 
                    V5 = "Function name") %>% 
  bg(i = ~ grepl("tbc", V2), j = 3, bg="#fabfd4") %>% 
  bg(i = ~ grepl("tbc", V3), j = 4, bg="#fabfd4") %>% 
  bg(i = ~ grepl("tbc", V4), j = 5, bg="#fabfd4") %>% 
  bg(i = ~ grepl("tbc", V5), j = 6, bg="#fabfd4") %>%
  bg(i = ~ grepl("(da)", V1), j = 2, bg="lightgrey") %>% 
  add_footer_lines(value = as_paragraph("(da) indicates decided against. tbc - to be completed"), top = FALSE) %>% 
  surround(part = "body", border.left = std_border, border.right = std_border, border.bottom = std_border)

```

<br>

# Exporting tables

There are two functions provided for this, and a supporting one:  

* *style_hux_df* - takes as an argument a gtsummary object produced by these functions and returns a formatted huxtable.      
* *addh* - takes as argument an `openxlsx` workbook and sheet name (as a character vector), along with a huxtabe to be added to that workbook and sheet. 
  *  `.col_width` is a supporting function used within addh that must be loaded.

```{r example application, collapse=TRUE}

# Easiest to copy all these packages into a script using these functions
library(tidyverse)
library(labelled)
library(gtsummary)
library(huxtable)
library(openxlsx)
library(haven)

# For all I use the compact theme.
theme_gtsummary_compact()

# Load BSA teaching data
df <- read_sav('/Users/joecrowley/R/Data/BSA Teaching Data/spss/spss25/bsa2019_poverty_open.sav', user_na = T)
df <- df %>% mutate(across(c(skipmeal, RSex, HEdQual3), ~fct_drop(to_factor(.x, user_na_to_na = T))))


# source cross break
source("/Users/joecrowley/R/Tables/gtsummary/.cbreak.R")

# Show function code... 
.cbreak

tbl <- df %>% .cbreak(outcome = "skipmeal", crossbreak = "RSex")
tbl

```














