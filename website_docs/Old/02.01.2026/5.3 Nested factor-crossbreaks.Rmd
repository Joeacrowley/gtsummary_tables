---
title: "Nested factor crossbreak"
output: 
  html_document:  
    toc: true   
    toc_depth: 2  
    toc_float: true
toc-title: "Table of Contents"
---

# Set up

```{r packages, collapse=TRUE}
library(gtsummary)
library(tidyverse)
library(srvyr)
library(flextable)
library(officer)
library(labelled)
library(rlang)
```

<br>

Typical theme for gtsummary()

```{r set theme}

# For all I use the compact theme.
theme_gtsummary_compact()

```

<br>

Load Round 10 UK European Social Survey dataset. 

```{r}

ddir <- "/Users/joecrowley/R/Tables/gtsummary"
load(paste0(ddir,"/ESS_UK_snippet_Round 10.RData"))
glimpse(ess10)

svy_df <- ess10 %>% as_survey_design(weights = anweight)

```

<br>

# Why are some p-value suppression in nested tables

In  nested tables  some p-values are suppressed, even though these are based on quite a large sample size. This does not seem to be linked to using the tbl_strata function or a feature of how the significance test (Fisher's Exact Test) is calculated, but a feature of Fisher's Exact Test, not a bug in tbl_strata.

<br>

# Nested crossbreak function

```{r}

vars <- c("lrscale","atchctr")

ncbreak <- function(
  data, 
  outcomes, 
  predictor, 
  nest
  ) {

suppressWarnings({suppressMessages({

cross_break <- list()

for (i in 1:length(outcomes)) {
  
o_var <- outcomes[i]
by_var <- predictor
base_name <- paste0("base_size",i)
nvar <- nest

df_tmp <- data %>% 
  select(all_of(c(o_var, by_var, nvar))) %>%
  filter(!is.na(.data[[nvar]])) %>% # Filter NA in nesting variable
  mutate(!!base_name := case_when(is.na(.data[[by_var]]) ~ NA, is.na(.data[[o_var]]) ~ NA, TRUE ~ "Unweighted bases")) 

var_label(df_tmp[[base_name]]) <- ""

perc <- 
  df_tmp %>%
    tbl_strata(strata = {{nvar}}, 
  ~.x %>% 
    tbl_summary(
      include = all_of(c(o_var, base_name)), 
      by = .data[[by_var]],
      missing = "no", 
      statistic = list(all_categorical() ~ "{p}", {{base_name}} ~ "{n}"),
      digits = list(all_categorical() ~ 0)
      ) %>%
      add_stat_label(label = {{base_name}} ~ "", location = "column") %>% 
      add_overall(last=TRUE) %>% # non-missing cases for each variable 
      modify_header(all_stat_cols() ~ "**{level}**", 
                    label ~ "**Variable**",
                    stat_0 ~ "**Total**",
                    stat_label ~ "")  %>%
  bold_labels() %>% 
  add_p(include = !all_of(base_name)) %>%
      modify_footnote(all_stat_cols() ~ NA), 
            .header = "**{strata}**, N = {n}"
    ) # close nested table description

cross_break[[i]] <- perc

}

table <- cross_break %>% tbl_stack() %>% 
  modify_caption(paste0("<div style='text-align: left; font-weight: bold; color: black'>",
                 "Crosstabulation by ", var_label(data[[by_var]]),", nested by ", var_label(data[[nvar]]),".",
                 "</div>")) %>% 
  # Drop all but first column of percentage labels. 
  modify_column_hide(contains("stat_label_") & !contains("stat_label_1"))

})})

return(table)

}

```

<br> 

## Example

```{r}

ess10 %>% 
  mutate(across(all_of(c(vars, "gndr", "hincfel")), ~fct_drop(.x))) %>% 
  ncbreak(
  outcomes = vars, 
  predictor = "gndr", 
  nest = "hincfel"
  )

```

<br>

```{r}

writeLines(
  c("ncbreak <- ", # Assignment needs to be added manually
  deparse(ncbreak)), # Extract function code
  paste0(ddir,"/ncbreak.R")) # File name is just the function name 

```

<br>

# Weighted nested crossbreak function

```{r}
vars <- c("lrscale","atchctr")

svy_ncbreak <- function(
  data, 
  outcomes, 
  predictor, 
  nest
  ) {

suppressWarnings({suppressMessages({

cross_break <- list()

for (i in 1:length(outcomes)) {
  
o_var <- outcomes[i]
by_var <- predictor
base_name <- paste0("base_size",i)
nvar <- nest

df_tmp <- data %>% 
  select(all_of(c(outcomes, by_var, nvar))) %>%
  filter(!is.na(.data[[nvar]])) %>% # Filter NA in nesting variable
  mutate(!!base_name := case_when(is.na(.data[[by_var]]) ~ NA, is.na(.data[[o_var]]) ~ NA, TRUE ~ "Unweighted bases"))

var_label(df_tmp[["variables"]][[base_name]]) <- ""

perc <- 
  df_tmp %>%   
  tbl_strata(strata = {{nvar}}, 
  ~.x %>% 
  tbl_svysummary(
  include = all_of(c(o_var, base_name)), 
  by = .data[[by_var]],
  missing = "no", 
  statistic = list(all_categorical() ~ "{p}", base_name ~ "{n_unweighted}"),
  digits = list(all_categorical() ~ 0)
  ) %>%
  add_stat_label(label = {{base_name}} ~ "", location = "column") %>% 
  add_overall(last=TRUE) %>% # non-missing cases for each variable 
  modify_header(all_stat_cols() ~ "**{level}**", 
                label ~ "**Variable**",
                stat_0 ~ "**Total**",
                stat_label ~ "")  %>%
  bold_labels() %>% 
  add_p(include = !all_of(base_name)) %>%
      modify_footnote(all_stat_cols() ~ NA), 
            .header = "**{strata}**, N = {n_unweighted}"
    ) # close nested table description 

  # For nested svy tables labels are lost, add manually.
  perc <- perc %>% 
    modify_table_body(
    ~ .x %>%
      dplyr::mutate(label = case_when(
        label == o_var ~ var_label(data[["variables"]][[o_var]]),
        label == base_name ~ " ",
        TRUE ~ label)
      ))

cross_break[[i]] <- perc

}

table <- cross_break %>% tbl_stack() %>% 
  modify_caption(paste0("<div style='text-align: left; font-weight: bold; color: black'>",
                 "Crosstabulation by ", 
                 var_label(data[["variables"]][[by_var]]),", 
                 nested by ", 
                 var_label(data[["variables"]][[nvar]]),".",
                 "</div>")) %>% 
  # Drop all but first column of percentage labels. 
  modify_column_hide(contains("stat_label_") & !contains("stat_label_1"))

})})
  
return(table)

}

```

<br>

## Example 

```{r}

svy_df %>% 
  mutate(across(all_of(c(vars, "gndr", "hincfel")), ~fct_drop(.x))) %>% 
  svy_ncbreak(
  outcomes = vars, 
  predictor = "gndr", 
  nest = "hincfel"
  ) 

```

<br>

```{r}

writeLines(
  c("svy_ncbreak <- ", # Assignment needs to be added manually
  deparse(svy_ncbreak)), # Extract function code
  paste0(ddir,"/svy_ncbreak.R")) # File name is just the function name 

```

<br>

