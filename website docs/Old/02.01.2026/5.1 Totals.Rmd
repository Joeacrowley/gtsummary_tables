---
title: "Frequencies"
output:  
  html_document:  
    toc: true   
    toc_depth: 2  
    toc_float: true
toc-title: "Table of Contents"
---

# Set up

```{r packages, collapse=TRUE}
library(gtsummary)
library(tidyverse)
library(srvyr)
library(flextable)
library(officer)
library(labelled)
library(rlang)
```

<br>

Typical theme for gtsummary()

```{r set theme}

# For all I use the compact theme.
theme_gtsummary_compact()

```

<br>

Load Round 10 UK European Social Survey dataset. 

```{r}

ddir <- "/Users/joecrowley/R/Tables/gtsummary"
load(paste0(ddir,"/ESS_UK_snippet_Round 10.RData"))
glimpse(ess10)

ess10 <- ess10 %>% 
  mutate(across(all_of(c("lrscale","atchctr","psppsgva","hincfel")), ~fct_drop(.x))) 

svy_df <- ess10 %>% as_survey_design(weights = anweight)


```

<br>

# Frequency table {.tabset}

```{r}
totals <- function(data, # a dataframe
                  variables, # a vector of variable names (prefers, perhaps requires, factors)
                  stat = "{p}", # character vector for statistic - takes "{n}" and "{p}" 
                  caption = NULL, # character vector, used if not NULL
                  ci = NULL # if TRUE then add confidence intervals
                  ) { 

statistic_label <- ifelse(stat == "{p}", " (%)", "") %>% paste0("**{level}", .,"**")
footnot_text <- ifelse(stat == "{p}", "Unweighted percentages. Base size shown in column N", "Unweighted count. Base size shown in column N")

if (is.null(caption)) {caption <- ifelse(stat == "{p}", "Unweighted percentages", "Unweighted count")}

 table <- 
  data %>% 
  tbl_summary(
  include = all_of(variables), 
  missing = "no", 
  statistic = list(all_categorical() ~ stat), 
  digits = list(all_categorical() ~ 0)
  ) %>% 
  modify_header(all_stat_cols() ~ statistic_label, label ~ "**Variable**") %>% 
  bold_labels() %>% 
    modify_caption(paste0("<div style='text-align: left; font-weight: bold; color: black'>", caption,"</div>")) %>%
  add_n(last=TRUE) %>% # non-missing cases for each variable 
 modify_footnote(all_stat_cols() ~ footnot_text)
 
 if (!is.null(ci)){
   
   table <- table %>% add_ci(statistic = list(all_categorical() ~ "{conf.low}-{conf.high}"),
         style_fun = all_categorical() ~ label_style_sigfig(scale = 100, digits = 1))
   
 }
  
  return(table)
  
}

```

<br> 

## Examples 

### Example 1

```{r}

ess10 %>% 
  totals(c("lrscale","atchctr","psppsgva","hincfel"))

```

<br> 

### Example 2

```{r}
ess10 %>% 
  totals(c("lrscale"), stat = "{n}", caption = "Unweighted frequencies of left right scale")

```

<br> 

### Example 3

```{r}

ess10 %>% 
  totals(c("lrscale"), stat = "{n}", ci = TRUE,
        caption = "Unweighted frequencies with confidence intervals")

```

<br> 

```{r}

writeLines(
  c("totals <- ", # Assignment needs to be added manually
  deparse(totals)), # Extract function code
  paste0(ddir,"/totals.R")) # File name is just the function name 

```

<br><br>

# Weighted frequencies {.tabset}

```{r}

svy_totals <- function(data, # a survey design object
                  variables, # a vector of variable names (prefers, perhaps requires, factors)
                  stat = "{p}", # character vector for statistic - takes "{n}" and "{p}" 
                  caption = NULL # character vector, used if not NULL
                  ) { 

statistic_label <- ifelse(stat == "{p}", " (%)", "") %>% paste0("**{level}", .,"**")
footnot_text <- ifelse(stat == "{p}", "Weighted percentages. Base size shown in column N", "Weighted count. Base size shown in column N")
if (is.null(caption)) {caption <- ifelse(stat == "{p}", "Weighted percentages", "Weighted count")}

 table <- 
  data %>% 
    tbl_svysummary(
    include = all_of(variables), 
    missing = "no", 
    statistic = list(all_categorical() ~ stat), 
    digits = list(all_categorical() ~ 0)
    ) %>% 
    modify_header(all_stat_cols() ~ statistic_label, label ~ "**Variable**") %>% 
    bold_labels() %>% 
    modify_caption(paste0("<div style='text-align: left; font-weight: bold; color: black'>", caption,"</div>")) %>%
    add_n(statistic = "{N_nonmiss_unweighted}", last=TRUE) %>% # non-missing cases for each variable 
    modify_footnote(all_stat_cols() ~ footnot_text)
  
  return(table)
  
}

```

<br> 

## Examples 

### Example 1

```{r}

svy_df %>% 
  svy_totals(c("lrscale","atchctr","psppsgva","hincfel"))

```

<br> 

### Example 2

```{r}

svy_df %>% 
  svy_totals(c("lrscale"), stat = "{n}", caption  = "Weighted counts")

```

<br>

```{r}

writeLines(
  c("svy_totals <- ", # Assignment needs to be added manually
  deparse(svy_totals)), # Extract function code
  paste0(ddir,"/svy_totals.R")) # File name is just the function name 

```

<br>

# Multiple frequencies

In my original version I imposed a requirement that all levels be equal, in the end I removed this because it was causing issues with overly strictness - preventing it running when really it was fine to do so. However, it may give odd results. 

```{r}

outcome_vars <- list("stflife", "stfgov")

mtotals <- function(
  outcomes, # Vector of outcomes
  data, # Data frame
  caption = "Unweighted percentages"
  ) {

result <- map(
  outcomes, 
  ~ tbl_summary(
      data = data %>% mutate(across(all_of(.x), ~fct_drop(.x), .names = "the_merging_variable"), 
                             mutate(across(all_of(.x), ~case_when(!is.na(.x) ~ "Unweighted base"), .names = "base"))) %>% 
        set_variable_labels(base = " "),
      include = c(the_merging_variable, base),  
      statistic = list(all_categorical() ~ "{p}", base ~ "{n}"),
      label = list(the_merging_variable ~ " "), 
      missing = "no", 
      digits = everything() ~ 0
  ) %>% 
    modify_header(stat_0 = paste0("**", var_label(data[[.x]]), "**"), label = "") %>% 
    modify_footnote(everything() ~ NA)
)

result <- tbl_merge(result, tab_spanner=F) 

result <- 
  result %>%
  modify_table_body(
    ~ .x %>%
      dplyr::mutate(row_id = row_number()) %>%
      dplyr::mutate(across(starts_with("stat_"), ~case_when(row_id == 1 ~ "%", TRUE ~ .x))) %>% 
      dplyr::select(-row_id) 
  )

 result <- result %>%  modify_caption(paste0("<div style='text-align: left; font-weight: bold; color: black'>", 
                                 caption, 
                                 "</div>"))
  
 return(result)
  
}

```

<br>

## Example 

```{r}
tbl <- ess10 %>% mtotals(outcomes = outcome_vars)
tbl

```

<br>

```{r}

writeLines(
  c("mtotals <- ", # Assignment needs to be added manually
  deparse(mtotals)), # Extract function code
  paste0(ddir,"/mtotals.r")) # File name is just the function name 

```

<br>

# Weighted multiple frequencies

```{r}

svy_mtotals <- function(
  outcomes, # Vector of outcomes
  data, # Data frame
  caption = "Weighted percentages"
  ) {

  results <- 
    map(outcomes, function(outcome){
  
    table_data <- data %>% 
      mutate(across(all_of(outcome), ~fct_drop(.x), .names = "the_merging_variable")) %>%  
      mutate(across(all_of(outcome), ~case_when(!is.na(.x) ~ "Unweighted base"), .names = "base"))
    
    var_label(table_data[["variables"]]["base"]) <- ""
    
    result <-  
      tbl_svysummary(
          data = table_data,
          include = c(the_merging_variable, base),  
          statistic = list(all_categorical() ~ "{p}", base ~ "{n_unweighted}"),
          label = list(the_merging_variable ~ " "), 
          missing = "no", 
          digits = everything() ~ 0
      ) %>% 
        modify_header(stat_0 = paste0("**", var_label(data[["variables"]][[outcome]]), "**"), label = "") %>% 
        modify_footnote(everything() ~ NA)
    
    
  })
  
  result <- tbl_merge(results, tab_spanner=F) 
  
  result <- 
    result %>%
    modify_table_body(
      ~ .x %>%
        dplyr::mutate(row_id = row_number()) %>%
        dplyr::mutate(across(starts_with("stat_"), ~case_when(row_id == 1 ~ "%", TRUE ~ .x))) %>% 
        dplyr::select(-row_id) 
    )
  
   result <- result %>%  modify_caption(paste0("<div style='text-align: left; font-weight: bold; color: black'>", 
                                   caption, 
                                   "</div>"))
    
   return(result)
  
}

```

## Examples

```{r}

tbl <- svy_df %>% svy_mtotals(outcomes = outcome_vars)
tbl

```

<br>

```{r}

writeLines(
  c("svy_mtotals <- ", # Assignment needs to be added manually
  deparse(svy_mtotals)), # Extract function code
  paste0(ddir,"/svy_mtotals.R")) # File name is just the function name 

```
























